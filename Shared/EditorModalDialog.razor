@using BetterBudgetWeb.Data
@using BetterBudgetWeb.Repo
<style>
    option {
        color: black;
    }

    select {
        color: black;
    }

    input {
        color: black;
    }

    button {
        color: black;
    }
</style>
@if (!Mobile)
{
    <div class="modal show" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true" style="background-color:rgba(0,0,0,.8);">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width:fit-content;position: absolute;left: 50%; top: 50%;
                        transform: translate(-50%, 0%);background-image:url('https://www.publicdomainpictures.net/pictures/410000/velka/pergament-papier-hintergrund-braun.jpg');">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-size:large;font-family:'Imprint MT Shadow';color:black;">
                        <strong>Editting Transaction</strong>
                    </h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" @onclick="@ModalCancel">
                    </button>
                </div>
                <div class="modal-body" style="width:fit-content;color:black;">
                    <EditForm Model="@Transact">
                        <table>
                            <tr>
                                <td>
                                    <label>Date</label>
                                </td>
                                <td>
                                    <label>Expense Type</label>
                                </td>
                                <td>
                                    <label>Name</label>
                                </td>
                                <td>
                                    <label>@(Constants.Person1)</label>
                                </td>
                                <td>
                                    <label>@(Constants.Person2)</label>
                                </td>
                                <td>
                                    <label>Total</label>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding:1vw">
                                    <InputDate @bind-Value="Transact.DateOfTransaction" />
                                </td>
                                <td style="padding:1vw">
                                    <ExpenseTypeInput @bind-NewExpense=@Transact.ExpenseType />
                                </td>
                                <td style="padding:1vw">
                                    <InputText @bind-Value="Transact.Name" />
                                </td>
                                <td style="padding:1vw">
                                    <InputNumber @bind-Value="Transact.Person1Amount" style="width: 5vw;margin-bottom:.5vw" />
                                    <PaymentInput @bind-NewExpense="@Transact.ExpenseType" 
                                            @bind-PaidWith="@Transact.PaidWithPerson1" Person="@Constants.Person1" />
                                </td>
                                <td style="padding:1vw">
                                    <InputNumber @bind-Value="Transact.Person2Amount" style="width: 5vw;margin-bottom:.5vw" />
                                    <PaymentInput @bind-NewExpense="@Transact.ExpenseType"
                                              @bind-PaidWith="@Transact.PaidWithPerson2" Person="@Constants.Person2" />
                                </td>
                                <td style="padding:1vw">
                                    <label>@Transact.TotalAmount</label>
                                </td>
                            </tr>
                        </table>
                    </EditForm>
                    <p style="color:red">@ErrorMsg</p>
                </div>
                <div class="modal-footer">

                    <button type="button" disabled=@Disabled class="btn btn-secondary" style="position:absolute;left:1vw;" data-dismiss="modal" @onclick="@ModalCancel">Close</button>
                    <button type="button" disabled=@Disabled class="btn btn-danger" data-dismiss="modal" @onclick="@ModalDecline">Decline</button>
                    <button type="button" disabled=@Disabled class="btn btn-success" data-dismiss="modal" @onclick="@ModalAccept">Accept</button>

                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="modal show" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true" style="background-color:rgba(0,0,0,.8);">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="width:fit-content;margin:0 auto;background-image:url('https://www.publicdomainpictures.net/pictures/410000/velka/pergament-papier-hintergrund-braun.jpg');">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-size:large;font-family:'Imprint MT Shadow';color:black;">
                        <strong>Editting Transaction</strong>
                    </h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" @onclick="@ModalCancel">
                    </button>
                </div>
                <div class="modal-body" style="width:100%;color:black;">
                    <EditForm Model="@Transact">
                        <table>
                            <tr>
                                <td style="font-size:3vw;"><label style="text-decoration:underline">Parameter</label></td>
                                <td style="font-size:3vw;"><label style="text-decoration:underline">Value</label></td>
                            </tr>
                            <tr>
                                <td style="font-size:3vw">
                                    <label>Date</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <InputDate @bind-Value="Transact.DateOfTransaction" />
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size:3vw;padding:1vw">
                                    <label>Expense Type</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <ExpenseTypeInput @bind-NewExpense=@Transact.ExpenseType />
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size:3vw">
                                    <label>Name</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <InputText @bind-Value="Transact.Name" />
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size:3vw;padding:1vw;">
                                    <label>@(Constants.Person1 + " Values")</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <InputNumber @bind-Value="Transact.Person1Amount" style="width: 15vw;margin-bottom:.5vw" />
                                    <br />
                                    <PaymentInput @bind-NewExpense="@Transact.ExpenseType"
                                              @bind-PaidWith="@Transact.PaidWithPerson1" Person="@Constants.Person1" />
                                </td>
                            </tr>
                            <tr>
                                <td style="font-size:3vw;padding:1vw;">
                                    <label>@(Constants.Person2 + " Values")</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <InputNumber @bind-Value="Transact.Person2Amount" style="width: 15vw;margin-bottom:.5vw" />
                                    <br />
                                    <PaymentInput @bind-NewExpense="@Transact.ExpenseType"
                                              @bind-PaidWith="@Transact.PaidWithPerson2" Person="@Constants.Person2" />
                                </td>
                            </tr>
                            <tr>

                                <td style="font-size:3vw">
                                    <label>Total</label>
                                </td>
                                <td style="font-size:3vw;padding:1vw">
                                    <label>@Transact.TotalAmount</label>
                                </td>
                            </tr>
                        </table>
                    </EditForm>
                    <p style="color:red">@ErrorMsg</p>
                </div>
                <div class="modal-footer">
                    <button type="button" disabled=@Disabled class="btn btn-danger" style="position:absolute;left:1vw;" data-dismiss="modal" @onclick="@ModalCancel">Decline</button>
                    <button type="button" disabled=@Disabled class="btn btn-success" data-dismiss="modal" @onclick="@ModalAccept">Accept</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Title { get; set; }

    [Parameter]
    public string Text { get; set; }

    [Parameter]
    public Transaction Transact { get; set; }

    [Parameter]
    public EventCallback<bool> OnClose { get; set; }

    public List<Data.Envelope> Person1Envelopes;
    public List<Data.Envelope> Person2Envelopes;

    public List<Balance> Person1Balances;
    public List<Balance> Person2Balances;

    private string Envelope1Header = "-- Envelopes --";
    private string Balance1Header = "-- Payment --";
    private string Envelope2Header = "-- Envelopes --";
    private string Balance2Header = "-- Payment --";

    private string errorMsg = "";
    private string ErrorMsg
    {
        get { return errorMsg; }
        set
        {
            errorMsg = value;
            StateHasChanged();
        }
    }

    public bool Mobile => Constants.Mobile;

    private bool Disabled;

    protected override Task OnInitializedAsync()
    {
        Person1Balances = Constants.Balances.Where(b => b.Person == Constants.Person1 || b.Person.ToUpper() == "JOINT").OrderBy(ba => ba.Name).ToList();
        Person2Balances = Constants.Balances.Where(b => b.Person == Constants.Person2 || b.Person.ToUpper() == "JOINT").OrderBy(ba => ba.Name).ToList();

        return base.OnInitializedAsync();
    }

    private Task ModalCancel()
    {
        Disabled = true;
        return OnClose.InvokeAsync(false);
    }

    private async Task ModalDecline()
    {
        Disabled = true;
        await OnClose.InvokeAsync(false);
    }

    private async Task ModalAccept()
    {
        ErrorMsg = "";
        Disabled = true;
        string badType = "Envelope";
        if (Transact.ExpenseType == "Envelope")
        {
            if (!string.IsNullOrEmpty(Transact.PaidWithPerson1) &&
                Transact.PaidWithPerson1 != "none" &&
                !Person1Envelopes.Select(e => e.Name).Contains(Transact.PaidWithPerson1))
                Transact.PaidWithPerson1 = "";

            if (!string.IsNullOrEmpty(Transact.PaidWithPerson2) &&
                Transact.PaidWithPerson2 != "none" &&
                !Person2Envelopes.Select(e => e.Name).Contains(Transact.PaidWithPerson2))
                Transact.PaidWithPerson2 = "";
            badType = "n Envelope";
        }
        else
        {
            if (!string.IsNullOrEmpty(Transact.PaidWithPerson1) &&
                Transact.PaidWithPerson1 != "none" &&
                !Person1Balances.Select(e => e.Name).Contains(Transact.PaidWithPerson1))
                Transact.PaidWithPerson1 = "";

            if (!string.IsNullOrEmpty(Transact.PaidWithPerson2) &&
                Transact.PaidWithPerson2 != "none" &&
                !Person2Balances.Select(e => e.Name).Contains(Transact.PaidWithPerson2))
                Transact.PaidWithPerson2 = "";
            badType = " Payment";
        }

        if (string.IsNullOrEmpty(Transact.PaidWithPerson1) && string.IsNullOrEmpty(Transact.PaidWithPerson2))
        {
            Disabled = false;
            ErrorMsg = "Enter a" + badType + " value for at least 1 person.";
            return;
        }

        await TransactionRepo.AddOrUpdateAsync(Transact);
        await OnClose.InvokeAsync(true);
    }
}